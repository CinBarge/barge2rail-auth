{% extends "admin/base_site.html" %}
{% load i18n admin_urls permission_tags static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; <a href="{% url 'admin:sso_role_changelist' %}">Roles</a>
    &rsaquo; <a href="{% url 'admin:sso_role_change' role.pk %}">{{ role.name }}</a>
    &rsaquo; Edit Permissions
</div>
{% endblock %}

{% block content %}
<!-- Toast messages -->
{% if messages %}
<div class="toast-container">
    {% for message in messages %}
    <div class="toast toast-{{ message.tags }}" id="toast-{{ forloop.counter }}">
        {{ message }}
        <button onclick="this.parentElement.remove()">&times;</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="role-info">
    <h2>{{ role.name }}</h2>
    <p><strong>Application:</strong> {{ role.application.name }}</p>
    <p><strong>Code:</strong> {{ role.code }}</p>
    {% if role.description %}
    <p><strong>Description:</strong> {{ role.description }}</p>
    {% endif %}
    {% if role.legacy_role %}
    <p><strong>Legacy Role:</strong> {{ role.legacy_role }}</p>
    {% endif %}
</div>

<div class="actions-row">
    <button type="button" class="button" onclick="cloneRole()">Clone This Role</button>
    <a href="{% url 'sso_role_history' role.pk %}" class="button">View History</a>
    <a href="{% url 'sso_rbac_dashboard' %}" class="btn-secondary">Back to Dashboard</a>
</div>

{% if affected_count > 0 %}
<div class="user-impact-warning">
    <strong>&#9888; Impact Warning:</strong> {{ affected_count }} user{{ affected_count|pluralize }} currently {{ affected_count|pluralize:"has,have" }} this role:
    <span class="affected-users">
        {% for user in affected_users|slice:":5" %}{{ user.email }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if affected_count > 5 %} and {{ affected_count|add:"-5" }} more...{% endif %}
    </span>
</div>
{% endif %}

<form method="post" id="permission-form">
    {% csrf_token %}

    <div class="quick-actions">
        <strong>Quick Actions:</strong>
        <button type="button" onclick="selectAll()">Select All</button>
        <button type="button" onclick="clearAll()">Clear All</button>
        <button type="button" onclick="selectReadOnly()">Read-Only (View)</button>
        <button type="button" onclick="selectReadWrite()">Read-Write</button>
        <button type="button" onclick="selectFullAccess()">Full Access</button>
    </div>

    <table class="permission-matrix">
        <thead>
            <tr>
                <th class="feature-header">Feature</th>
                {% for permission in permissions %}
                <th onclick="toggleColumn('{{ permission.code }}')"
                    title="Click to toggle all {{ permission.name }}">
                    {{ permission.name }}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for feature in features %}
            <tr>
                <td class="feature-name"
                    onclick="toggleRow({{ feature.id }})"
                    title="Click to toggle all permissions for {{ feature.name }}">
                    {{ feature.name }}
                    {% if feature.description %}
                    <br><small>{{ feature.description }}</small>
                    {% endif %}
                </td>
                {% for permission in permissions %}
                <td>
                    {% is_permission_set current_perms feature.id permission.id as is_checked %}
                    <input type="checkbox"
                           name="feature_{{ feature.id }}"
                           value="{{ permission.id }}"
                           data-perm="{{ permission.code }}"
                           data-feature="{{ feature.id }}"
                           {% if is_checked %}checked{% endif %}>
                </td>
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ permissions|length|add:1 }}" class="empty-message">
                    No features defined for this application.
                    <a href="{% url 'admin:sso_feature_add' %}">Add features</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="submit-row">
        <span class="change-indicator" id="changeIndicator">Unsaved changes</span>
        <a href="{% url 'admin:sso_role_change' role.pk %}" class="cancel-link">Cancel</a>
        <input type="submit" value="Save Permissions" id="saveBtn">
    </div>
</form>

<script>
// Store initial state for change tracking
let initialState = {};
window.hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', function() {
    // Store initial checkbox states
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        const key = cb.name + '_' + cb.value;
        initialState[key] = cb.checked;
        cb.addEventListener('change', trackChanges);
    });

    // Auto-hide toasts after 5 seconds
    setTimeout(function() {
        document.querySelectorAll('.toast').forEach(toast => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        });
    }, 5000);
});

// Warn on leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (window.hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Clear flag on form submit
document.getElementById('permission-form').addEventListener('submit', function() {
    window.hasUnsavedChanges = false;
});

function trackChanges() {
    let hasChanges = false;
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        const key = cb.name + '_' + cb.value;
        const changed = initialState[key] !== cb.checked;
        cb.closest('td').classList.toggle('changed', changed);
        if (changed) hasChanges = true;
    });

    // Update UI indicators
    window.hasUnsavedChanges = hasChanges;
    document.getElementById('saveBtn').classList.toggle('changed', hasChanges);
    document.getElementById('changeIndicator').classList.toggle('visible', hasChanges);
}

function toggleColumn(permCode) {
    const checkboxes = document.querySelectorAll(`[data-perm="${permCode}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    trackChanges();
}

function toggleRow(featureId) {
    const checkboxes = document.querySelectorAll(`[name="feature_${featureId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    trackChanges();
}

function selectAll() {
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });
    trackChanges();
}

function clearAll() {
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    trackChanges();
}

function selectReadOnly() {
    clearAll();
    document.querySelectorAll('.permission-matrix input[data-perm="view"]').forEach(cb => {
        cb.checked = true;
    });
    trackChanges();
}

function selectReadWrite() {
    clearAll();
    ['view', 'create', 'modify'].forEach(perm => {
        document.querySelectorAll(`.permission-matrix input[data-perm="${perm}"]`).forEach(cb => {
            cb.checked = true;
        });
    });
    trackChanges();
}

function selectFullAccess() {
    selectAll();
}

function cloneRole() {
    const newName = prompt('Enter name for cloned role:', '{{ role.name }} (Copy)');
    if (newName && newName.trim()) {
        window.location.href = '/admin/sso/role/{{ role.id }}/clone/?name=' +
            encodeURIComponent(newName.trim());
    }
}
</script>
{% endblock %}
