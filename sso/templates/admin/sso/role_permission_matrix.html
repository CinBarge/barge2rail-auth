{% extends "admin/base_site.html" %}
{% load i18n admin_urls permission_tags %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    .toast {
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    }
    .toast button {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* CBRT Green branding */
    .permission-matrix {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    .permission-matrix th,
    .permission-matrix td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
    }
    .permission-matrix th {
        background-color: #005500;
        color: white;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }
    .permission-matrix th:hover {
        background-color: #003300 !important;
    }
    .permission-matrix th.feature-header {
        text-align: left;
        min-width: 150px;
        cursor: default;
    }
    .permission-matrix th.feature-header:hover {
        background-color: #005500 !important;
    }
    .permission-matrix tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .permission-matrix tbody tr:hover {
        background-color: #e8f4e8 !important;
    }
    .permission-matrix tbody tr:hover td.feature-name {
        background-color: #d0e8d0 !important;
    }
    .permission-matrix td.feature-name {
        text-align: left;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }
    .permission-matrix input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Changed cell highlight */
    .permission-matrix td.changed {
        background-color: #fff3cd !important;
    }

    /* Quick actions - CBRT green */
    .quick-actions {
        margin: 15px 0;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 5px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .quick-actions strong {
        margin-right: 5px;
    }
    .quick-actions button {
        padding: 8px 15px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background-color: #005500;
        color: white;
        transition: background-color 0.2s;
    }
    .quick-actions button:hover {
        background-color: #003300;
    }

    /* Role info box - CBRT green */
    .role-info {
        background-color: #e8f4e8;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #005500;
    }
    .role-info h2 {
        margin: 0 0 10px 0;
        color: #005500;
    }
    .role-info p {
        margin: 5px 0;
        color: #666;
    }

    /* Actions row (clone button) */
    .actions-row {
        margin: 15px 0;
        display: flex;
        gap: 10px;
    }
    .actions-row .button {
        padding: 8px 15px;
        cursor: pointer;
        border: 1px solid #005500;
        border-radius: 4px;
        background-color: white;
        color: #005500;
        text-decoration: none;
        transition: all 0.2s;
    }
    .actions-row .button:hover {
        background-color: #005500;
        color: white;
    }

    /* Submit row */
    .submit-row {
        padding: 15px;
        background-color: #f5f5f5;
        text-align: right;
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 15px;
    }
    .submit-row input[type="submit"] {
        padding: 10px 25px;
        background-color: #005500;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }
    .submit-row input[type="submit"]:hover {
        background-color: #003300;
    }
    .submit-row input[type="submit"].changed {
        background-color: #28a745;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
        50% { box-shadow: 0 0 0 8px rgba(40, 167, 69, 0); }
    }
    .submit-row .cancel-link {
        color: #666;
        text-decoration: none;
    }
    .submit-row .cancel-link:hover {
        text-decoration: underline;
    }

    /* Change indicator */
    .change-indicator {
        color: #856404;
        background-color: #fff3cd;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 13px;
        display: none;
    }
    .change-indicator.visible {
        display: inline-block;
    }

    /* User impact warning */
    .user-impact-warning {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
    }
    .user-impact-warning strong {
        color: #856404;
    }
    .affected-users {
        display: block;
        margin-top: 8px;
        color: #666;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'admin:sso_role_changelist' %}">Roles</a>
    &rsaquo; <a href="{% url 'admin:sso_role_change' role.pk %}">{{ role.name }}</a>
    &rsaquo; Edit Permissions
</div>
{% endblock %}

{% block content %}
<!-- Toast messages -->
{% if messages %}
<div class="toast-container">
    {% for message in messages %}
    <div class="toast toast-{{ message.tags }}" id="toast-{{ forloop.counter }}">
        {{ message }}
        <button onclick="this.parentElement.remove()">&times;</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="role-info">
    <h2>{{ role.name }}</h2>
    <p><strong>Application:</strong> {{ role.application.name }}</p>
    <p><strong>Code:</strong> {{ role.code }}</p>
    {% if role.description %}
    <p><strong>Description:</strong> {{ role.description }}</p>
    {% endif %}
    {% if role.legacy_role %}
    <p><strong>Legacy Role:</strong> {{ role.legacy_role }}</p>
    {% endif %}
</div>

<div class="actions-row">
    <button type="button" class="button" onclick="cloneRole()">Clone This Role</button>
    <a href="{% url 'sso_role_history' role.pk %}" class="button">View History</a>
</div>

{% if affected_count > 0 %}
<div class="user-impact-warning">
    <strong>&#9888; Impact Warning:</strong> {{ affected_count }} user{{ affected_count|pluralize }} currently {{ affected_count|pluralize:"has,have" }} this role:
    <span class="affected-users">
        {% for user in affected_users|slice:":5" %}{{ user.email }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if affected_count > 5 %} and {{ affected_count|add:"-5" }} more...{% endif %}
    </span>
</div>
{% endif %}

<form method="post" id="permission-form">
    {% csrf_token %}

    <div class="quick-actions">
        <strong>Quick Actions:</strong>
        <button type="button" onclick="selectAll()">Select All</button>
        <button type="button" onclick="clearAll()">Clear All</button>
        <button type="button" onclick="selectReadOnly()">Read-Only (View)</button>
        <button type="button" onclick="selectReadWrite()">Read-Write</button>
        <button type="button" onclick="selectFullAccess()">Full Access</button>
    </div>

    <table class="permission-matrix">
        <thead>
            <tr>
                <th class="feature-header">Feature</th>
                {% for permission in permissions %}
                <th onclick="toggleColumn('{{ permission.code }}')"
                    title="Click to toggle all {{ permission.name }}">
                    {{ permission.name }}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for feature in features %}
            <tr>
                <td class="feature-name"
                    onclick="toggleRow({{ feature.id }})"
                    title="Click to toggle all permissions for {{ feature.name }}">
                    {{ feature.name }}
                    {% if feature.description %}
                    <br><small style="color: #888;">{{ feature.description }}</small>
                    {% endif %}
                </td>
                {% for permission in permissions %}
                <td>
                    {% is_permission_set current_perms feature.id permission.id as is_checked %}
                    <input type="checkbox"
                           name="feature_{{ feature.id }}"
                           value="{{ permission.id }}"
                           data-perm="{{ permission.code }}"
                           data-feature="{{ feature.id }}"
                           {% if is_checked %}checked{% endif %}>
                </td>
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ permissions|length|add:1 }}">
                    No features defined for this application.
                    <a href="{% url 'admin:sso_feature_add' %}">Add features</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="submit-row">
        <span class="change-indicator" id="changeIndicator">Unsaved changes</span>
        <a href="{% url 'admin:sso_role_change' role.pk %}" class="cancel-link">Cancel</a>
        <input type="submit" value="Save Permissions" id="saveBtn">
    </div>
</form>

<script>
// Store initial state for change tracking
let initialState = {};
window.hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', function() {
    // Store initial checkbox states
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        const key = cb.name + '_' + cb.value;
        initialState[key] = cb.checked;
        cb.addEventListener('change', trackChanges);
    });

    // Auto-hide toasts after 5 seconds
    setTimeout(function() {
        document.querySelectorAll('.toast').forEach(toast => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        });
    }, 5000);
});

// Warn on leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (window.hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Clear flag on form submit
document.getElementById('permission-form').addEventListener('submit', function() {
    window.hasUnsavedChanges = false;
});

function trackChanges() {
    let hasChanges = false;
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        const key = cb.name + '_' + cb.value;
        const changed = initialState[key] !== cb.checked;
        cb.closest('td').classList.toggle('changed', changed);
        if (changed) hasChanges = true;
    });

    // Update UI indicators
    window.hasUnsavedChanges = hasChanges;
    document.getElementById('saveBtn').classList.toggle('changed', hasChanges);
    document.getElementById('changeIndicator').classList.toggle('visible', hasChanges);
}

function toggleColumn(permCode) {
    const checkboxes = document.querySelectorAll(`[data-perm="${permCode}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    trackChanges();
}

function toggleRow(featureId) {
    const checkboxes = document.querySelectorAll(`[name="feature_${featureId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    trackChanges();
}

function selectAll() {
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });
    trackChanges();
}

function clearAll() {
    document.querySelectorAll('.permission-matrix input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    trackChanges();
}

function selectReadOnly() {
    clearAll();
    document.querySelectorAll('.permission-matrix input[data-perm="view"]').forEach(cb => {
        cb.checked = true;
    });
    trackChanges();
}

function selectReadWrite() {
    clearAll();
    ['view', 'create', 'modify'].forEach(perm => {
        document.querySelectorAll(`.permission-matrix input[data-perm="${perm}"]`).forEach(cb => {
            cb.checked = true;
        });
    });
    trackChanges();
}

function selectFullAccess() {
    selectAll();
}

function cloneRole() {
    const newName = prompt('Enter name for cloned role:', '{{ role.name }} (Copy)');
    if (newName && newName.trim()) {
        window.location.href = '/admin/sso/role/{{ role.id }}/clone/?name=' +
            encodeURIComponent(newName.trim());
    }
}
</script>
{% endblock %}
