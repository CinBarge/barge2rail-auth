{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; Bulk Role Assignment
</div>
{% endblock %}

{% block content %}
{% if messages %}
<div class="toast-container">
    {% for message in messages %}
    <div class="toast {% if message.tags %}{{ message.tags }}{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<h1>Bulk Role Assignment</h1>
<p>Assign multiple users to a role at once.</p>

<form method="post" class="rbac-form">
    {% csrf_token %}

    <div class="form-group">
        <label for="role">Select Role:</label>
        <select name="role" id="role" required>
            <option value="">-- Select a role --</option>
            {% for role in roles %}
            <option value="{{ role.id }}">{{ role.application.name }} - {{ role.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="tenant_code">Tenant Code (optional):</label>
        <select name="tenant_code" id="tenant_code">
            <option value="">-- No tenant (global) --</option>
            {% for code in tenant_codes %}
            <option value="{{ code }}">{{ code }}</option>
            {% endfor %}
        </select>
        <p class="help-text">Select a tenant if this role assignment is tenant-specific.</p>
    </div>

    <div class="form-group">
        <label for="users">Select Users:</label>
        <select name="users" id="users" multiple required>
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.email }}{% if user.first_name %} ({{ user.first_name }} {{ user.last_name }}){% endif %}</option>
            {% endfor %}
        </select>
        <p class="help-text">Hold Ctrl/Cmd to select multiple users.</p>
        <div class="selection-info" id="selectionInfo">0 users selected</div>
    </div>

    <div class="submit-row">
        <button type="submit" class="btn-primary">Assign Role to Selected Users</button>
        <a href="{% url 'sso_rbac_dashboard' %}" class="btn-secondary">Cancel</a>
    </div>
</form>

<script>
document.getElementById('users').addEventListener('change', function() {
    const count = this.selectedOptions.length;
    document.getElementById('selectionInfo').textContent = count + ' user' + (count !== 1 ? 's' : '') + ' selected';
});

// Auto-hide toasts
setTimeout(function() {
    document.querySelectorAll('.toast').forEach(toast => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    });
}, 5000);
</script>
{% endblock %}
