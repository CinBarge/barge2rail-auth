{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; Permission Search
</div>
{% endblock %}

{% block content %}
<h1>Permission Search</h1>
<p>Find which roles have a specific permission on a feature. Answer questions like "Who can delete BOLs?"</p>

<form method="get" class="select-form">
    <div class="form-row">
        <div class="form-group">
            <label for="app">Application (optional):</label>
            <select name="app" id="app">
                <option value="">All Applications</option>
                {% for app in apps %}
                <option value="{{ app.id }}" {% if selected_app == app.id|stringformat:"i" %}selected{% endif %}>
                    {{ app.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="feature">Feature:</label>
            <select name="feature" id="feature" required>
                <option value="">-- Select Feature --</option>
                {% for feature in features %}
                <option value="{{ feature.code }}" {% if selected_feature == feature.code %}selected{% endif %}>
                    {{ feature.application.name }} - {{ feature.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="permission">Permission:</label>
            <select name="permission" id="permission" required>
                <option value="">-- Select Permission --</option>
                {% for perm in permissions %}
                <option value="{{ perm.code }}" {% if selected_permission == perm.code %}selected{% endif %}>
                    {{ perm.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">Search</button>
    </div>
</form>

{% if selected_feature and selected_permission %}
    {% if results %}
    <div class="results-count">{{ results|length }} role(s) found</div>
    <table class="rbac-table">
        <thead>
            <tr>
                <th>Application</th>
                <th>Role</th>
                <th>Feature</th>
                <th>Users with Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result.role.application.name }}</td>
                <td>
                    <a href="{% url 'admin:sso_role_change' result.role.id %}">
                        {{ result.role.name }}
                    </a>
                </td>
                <td>{{ result.feature.name }}</td>
                <td>
                    <span class="user-count">{{ result.user_count }} user(s)</span>
                </td>
                <td>
                    <a href="{% url 'sso_role_permission_matrix' result.role.id %}">Edit Permissions</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-results">No roles found with "{{ selected_permission }}" permission on "{{ selected_feature }}" feature.</p>
    {% endif %}
{% endif %}

<a href="{% url 'sso_rbac_dashboard' %}" class="back-link">Back to Dashboard</a>
{% endblock %}
