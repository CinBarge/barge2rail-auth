{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; Compare Roles
</div>
{% endblock %}

{% block content %}
<h1>Compare Roles</h1>
<p>Side-by-side comparison of permissions between two roles.</p>

<form method="get" class="select-form">
    <div class="form-group">
        <label for="app">Application:</label>
        <select name="app" id="app" onchange="this.form.submit()">
            <option value="">-- Select Application --</option>
            {% for app in apps %}
            <option value="{{ app.id }}" {% if selected_app and selected_app.id == app.id %}selected{% endif %}>
                {{ app.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    {% if selected_app %}
    <div class="form-row">
        <div class="form-group">
            <label for="role1">Role 1:</label>
            <select name="role1" id="role1">
                <option value="">-- Select Role --</option>
                {% for role in available_roles %}
                <option value="{{ role.id }}" {% if role1 and role1.id == role.id %}selected{% endif %}>
                    {{ role.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="role2">Role 2:</label>
            <select name="role2" id="role2">
                <option value="">-- Select Role --</option>
                {% for role in available_roles %}
                <option value="{{ role.id }}" {% if role2 and role2.id == role.id %}selected{% endif %}>
                    {{ role.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">Compare</button>
    </div>
    {% endif %}
</form>

{% if role1 and role2 and comparison %}
<table class="rbac-table comparison-table">
    <thead>
        <tr>
            <th rowspan="2">Feature</th>
            {% for perm in comparison.0.permissions %}
            <th colspan="2" class="perm-header">{{ perm.perm.name }}</th>
            {% endfor %}
        </tr>
        <tr>
            {% for perm in comparison.0.permissions %}
            <th class="perm-header">{{ role1.name|truncatechars:15 }}</th>
            <th class="perm-header">{{ role2.name|truncatechars:15 }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in comparison %}
        <tr>
            <td>{{ row.feature.name }}</td>
            {% for p in row.permissions %}
            <td class="{% if p.diff == 'different' %}different{% endif %}">
                {% if p.role1 %}<span class="has-perm">&#10003;</span>{% else %}<span class="no-perm">&ndash;</span>{% endif %}
            </td>
            <td class="{% if p.diff == 'different' %}different{% endif %}">
                {% if p.role2 %}<span class="has-perm">&#10003;</span>{% else %}<span class="no-perm">&ndash;</span>{% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="legend">
    <span><span class="has-perm">&#10003;</span> = Has permission</span>
    <span><span class="no-perm">&ndash;</span> = No permission</span>
    <span style="background: rgba(245, 158, 11, 0.2); padding: 2px 8px; border-radius: 4px;">Yellow = Different</span>
</div>
{% elif selected_app and not role1 %}
<p class="empty-message">Select two roles to compare.</p>
{% endif %}

<a href="{% url 'sso_rbac_dashboard' %}" class="back-link">Back to Dashboard</a>
{% endblock %}
