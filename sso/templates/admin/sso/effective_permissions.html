{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; Effective Permissions
</div>
{% endblock %}

{% block content %}
<h1>Effective Permissions</h1>
<p>See what a specific user can actually do across all their roles.</p>

<form method="get" class="user-select-form">
    <label for="user_id">Select User:</label>
    <select name="user_id" id="user_id">
        <option value="">-- Select a user --</option>
        {% for user in all_users %}
        <option value="{{ user.id }}" {% if selected_user and selected_user.id == user.id %}selected{% endif %}>
            {{ user.email }}{% if user.first_name %} ({{ user.first_name }} {{ user.last_name }}){% endif %}
        </option>
        {% endfor %}
    </select>
    <button type="submit">Show Permissions</button>
</form>

{% if selected_user %}
<div class="user-info">
    <h2>{{ selected_user.email }}</h2>
    {% if selected_user.first_name %}
    <p>{{ selected_user.first_name }} {{ selected_user.last_name }}</p>
    {% endif %}
</div>

{% if permissions_by_app %}
    {% for app_name, app_data in permissions_by_app.items %}
    <div class="app-section">
        <div class="app-header">
            {{ app_name }}
            {% if app_data.tenant %}<small>(Tenant: {{ app_data.tenant }})</small>{% endif %}
        </div>
        <div class="app-roles">
            Roles:
            {% for role in app_data.roles %}
            <span class="role-tag">{{ role }}</span>
            {% endfor %}
        </div>
        {% if app_data.features %}
        <table class="perm-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    {% for perm in all_permissions %}
                    <th>{{ perm.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for feature_name, perms in app_data.features.items %}
                <tr>
                    <td>{{ feature_name }}</td>
                    {% for perm in all_permissions %}
                    <td>
                        {% if perm.code in perms %}
                        <span class="perm-check">&#10003;</span>
                        {% else %}
                        <span class="perm-x">&ndash;</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-perms">No feature permissions assigned.</p>
        {% endif %}
    </div>
    {% endfor %}
{% else %}
    <p class="no-perms">This user has no active role assignments.</p>
{% endif %}
{% endif %}

<a href="{% url 'sso_rbac_dashboard' %}" class="back-link">Back to Dashboard</a>
{% endblock %}
