{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'sso/css/rbac-theme.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} rbac-page{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='sso' %}">SSO</a>
    &rsaquo; <a href="{% url 'sso_rbac_dashboard' %}">RBAC</a>
    &rsaquo; <a href="{% url 'admin:sso_role_changelist' %}">Roles</a>
    &rsaquo; <a href="{% url 'admin:sso_role_change' role.pk %}">{{ role.name }}</a>
    &rsaquo; History
</div>
{% endblock %}

{% block content %}
<div class="role-info">
    <h2>{{ role.name }}</h2>
    <p><strong>Application:</strong> {{ role.application.name }}</p>
    <p><strong>Code:</strong> {{ role.code }}</p>
</div>

<div class="history-section">
    <h3>Role Changes</h3>
    {% if role_history %}
    <table class="rbac-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Changed By</th>
                <th>Type</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for record in role_history %}
            <tr>
                <td>{{ record.history_date|date:"M d, Y H:i" }}</td>
                <td>{{ record.history_user.email|default:"System" }}</td>
                <td>
                    <span class="change-type {% if record.history_type == '+' %}created{% elif record.history_type == '~' %}changed{% else %}deleted{% endif %}">
                        {% if record.history_type == '+' %}Created
                        {% elif record.history_type == '~' %}Changed
                        {% else %}Deleted{% endif %}
                    </span>
                </td>
                <td>{{ record.history_change_reason|default:"-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-message">No role history records found.</p>
    {% endif %}
</div>

<div class="history-section">
    <h3>Permission Changes</h3>
    {% if perm_history %}
    <table class="rbac-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Changed By</th>
                <th>Type</th>
                <th>Feature</th>
                <th>Permission</th>
            </tr>
        </thead>
        <tbody>
            {% for record in perm_history %}
            <tr>
                <td>{{ record.history_date|date:"M d, Y H:i" }}</td>
                <td>{{ record.history_user.email|default:"System" }}</td>
                <td>
                    <span class="change-type {% if record.history_type == '+' %}created{% elif record.history_type == '~' %}changed{% else %}deleted{% endif %}">
                        {% if record.history_type == '+' %}Added
                        {% elif record.history_type == '~' %}Changed
                        {% else %}Removed{% endif %}
                    </span>
                </td>
                <td>{{ record.feature.name|default:"(deleted)" }}</td>
                <td>{{ record.permission.name|default:"(deleted)" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-message">No permission history records found.</p>
    {% endif %}
</div>

<a href="{% url 'sso_role_permission_matrix' role.pk %}" class="back-link">Back to Permission Matrix</a>
{% endblock %}
