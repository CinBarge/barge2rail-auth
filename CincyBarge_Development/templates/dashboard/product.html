{% extends 'partials/base.html' %}
{% load dashboard_extras %}
{% block title %}Products Page{% endblock %}

{% block content %}
{% include 'partials/topnav.html'%}

<div class="container-fluid">
    <div class="row my-4">

        <!-- Left Column: Import & Add Product Forms -->
        <div class="col-md-4">

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Upload Raw Inventory Data Form -->
            <div class="card card-body mt-4">
                <h5>Upload Inventory Data</h5>
                <hr>
                <p class="text-muted small">Upload inventory data from CSV or JSON files. Data will be stored per supplier.</p>
                <form method="POST" action="{% url 'upload-raw-data' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Supplier Selection/Creation -->
                    <div class="form-group">
                        <label for="id_raw_supplier">Supplier</label>
                        <select name="supplier" id="id_raw_supplier" class="form-control" onchange="toggleNewSupplier()">
                            <option value="" disabled selected>Select a supplier</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                            <option value="new">+ Add New Supplier</option>
                        </select>
                    </div>

                    <!-- New Supplier Name Input (hidden by default) -->
                    <div class="form-group" id="newSupplierGroup" style="display: none;">
                        <label for="id_new_supplier_name">New Supplier Name</label>
                        <input type="text" name="new_supplier_name" id="id_new_supplier_name" class="form-control" placeholder="Enter new supplier name">
                        <small class="form-text text-muted">This will create a new supplier in the system</small>
                    </div>

                    <!-- File Upload -->
                    <div class="form-group">
                        <label for="id_file">File (CSV or JSON)</label>
                        <input type="file" name="file" id="id_file" class="form-control" accept=".csv,.json" required>
                        <small class="form-text text-muted">Upload a CSV or JSON file with inventory data</small>
                    </div>

                    <!-- Submit Button -->
                    <input class="btn btn-primary btn-block mt-3" type="submit" value="Upload File">
                </form>

                <!-- View Raw Data Button -->
                <a href="{% url 'raw-data-view' %}" class="btn btn-info btn-block mt-2">
                    View Uploaded Data
                </a>

                <!-- Sync Raw Data to Products -->
                <form method="POST" action="{% url 'sync-raw-data' %}" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-block"
                            onclick="return confirm('This will convert all uploaded raw data (CSV/JSON) into structured Product records. Continue?');">
                        <i class="fas fa-sync-alt"></i> Sync Uploaded Data to Products
                    </button>
                </form>
                <small class="text-muted d-block mt-1">Convert uploaded CSV/JSON data into structured products</small>
            </div>
        </div>

        <!-- Right Column: Unified Products Table -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Products Inventory (All Data)</h5>
                    <span class="badge badge-light" id="totalItemsCount">{{ total_rows }} total items</span>
                </div>

                <!-- Filter Controls -->
                <div class="card-body pb-2">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filterSupplier" class="small font-weight-bold">Filter by Supplier:</label>
                                <select id="filterSupplier" class="form-control form-control-sm">
                                    <option value="">All Suppliers</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.name }}">{{ supplier.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterOrganizedBy" class="small font-weight-bold">Organized by:</label>
                                <select id="filterOrganizedBy" class="form-control form-control-sm">
                                    <option value="">All Types</option>
                                    <option value="Bill of Lading">Bill of Lading</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterAvailability" class="small font-weight-bold">Availability:</label>
                                <select id="filterAvailability" class="form-control form-control-sm">
                                    <option value="">All</option>
                                    <option value="available">Available</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="filterSearch" class="small font-weight-bold">Search:</label>
                                <input type="text" id="filterSearch" class="form-control form-control-sm" placeholder="Search in table...">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button id="clearFilters" class="btn btn-sm btn-secondary">Clear All Filters</button>
                            <span class="ml-3 text-muted small">
                                Showing <strong id="visibleCount">{{ total_rows }}</strong> of <strong>{{ total_rows }}</strong> items
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card-body p-0 pt-2">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover table-sm bg-white mb-0">
                            <thead class="bg-info text-white" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th scope="col" class="text-nowrap">Supplier</th>
                                    <th scope="col" class="text-nowrap">Source</th>
                                    {% for column in all_columns %}
                                    <th scope="col" class="text-nowrap">{{ column }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in all_inventory_data %}
                                <tr>
                                    <td class="text-nowrap">
                                        <span class="badge badge-info">{{ row.supplier }}</span>
                                    </td>
                                    <td class="text-nowrap">
                                        <span class="badge badge-{% if row.source == 'Structured' %}success{% else %}warning{% endif %}">
                                            {{ row.source }}
                                        </span>
                                    </td>
                                    {% for column in all_columns %}
                                    <td>{{ row.data|get_item:column|default:"-" }}</td>
                                    {% endfor %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{{ all_columns|length|add:2 }}" class="text-center">No inventory data found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-footer">
                    <small class="text-muted">
                        <strong>Total Items:</strong> {{ total_rows }} |
                        <strong>Columns:</strong> {{ all_columns|length }}
                    </small>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Filter and Supplier Toggle Scripts -->
<script>
    // Toggle new supplier input field
    function toggleNewSupplier() {
        const supplierSelect = document.getElementById("id_raw_supplier");
        const newSupplierGroup = document.getElementById("newSupplierGroup");
        const newSupplierInput = document.getElementById("id_new_supplier_name");

        if (supplierSelect.value === "new") {
            newSupplierGroup.style.display = "block";
            newSupplierInput.required = true;
        } else {
            newSupplierGroup.style.display = "none";
            newSupplierInput.required = false;
            newSupplierInput.value = "";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const filterSupplier = document.getElementById("filterSupplier");
        const filterOrganizedBy = document.getElementById("filterOrganizedBy");
        const filterAvailability = document.getElementById("filterAvailability");
        const filterSearch = document.getElementById("filterSearch");
        const clearFiltersBtn = document.getElementById("clearFilters");
        const tableBody = document.querySelector(".table-responsive tbody");
        const rows = tableBody.querySelectorAll("tr");
        const visibleCountSpan = document.getElementById("visibleCount");
        const totalRows = rows.length;

        const bolFields = ['tagnbr', 'ponbr', 'spec', 'coilweig', 'heatlot', 'barge', 'tag'];
        const bolnoFields = ['bolno', 'bol', 'bol_number', 'bill_of_lading'];

        function isBillOfLading(row) {
            if (row.cells.length < 2) return false;
            const headers = document.querySelectorAll('.table-responsive thead th');
            const headerTexts = Array.from(headers).map(h => h.textContent.toLowerCase().trim());

            for (let i = 2; i < row.cells.length && i < headers.length; i++) {
                const headerName = headerTexts[i];
                const cellValue = row.cells[i].textContent.trim();
                const isBOLField = bolFields.some(bolField => headerName.includes(bolField.toLowerCase()));
                if (isBOLField && cellValue !== '' && cellValue !== '-') {
                    return true;
                }
            }
            return false;
        }

        function hasBOLNO(row) {
            if (row.cells.length < 2) return false;
            const headers = document.querySelectorAll('.table-responsive thead th');
            const headerTexts = Array.from(headers).map(h => h.textContent.toLowerCase().trim());

            for (let i = 2; i < row.cells.length && i < headers.length; i++) {
                const headerName = headerTexts[i];
                const cellValue = row.cells[i].textContent.trim();
                
                // Check if this is a BOLNO column (case insensitive, exact match or contains)
                const isBOLNOField = headerName === 'bolno' || 
                                     headerName.includes('bolno') || 
                                     headerName.includes('bol_number') ||
                                     headerName.includes('bill_of_lading');
                
                // If this is a BOLNO field and it has a value (not empty and not "-"), return true
                if (isBOLNOField && cellValue !== '' && cellValue !== '-') {
                    return true;
                }
            }
            // If we didn't find any BOLNO field with a value, return false (available)
            return false;
        }

        function filterTable() {
            const supplierVal = filterSupplier.value.trim();
            const organizedByVal = filterOrganizedBy.value.trim();
            const availabilityVal = filterAvailability.value.trim();
            const searchVal = filterSearch.value.toLowerCase().trim();
            let visibleCount = 0;

            const headers = document.querySelectorAll('.table-responsive thead th');
            const headerTexts = Array.from(headers).map(h => h.textContent.toLowerCase().trim());
            const isBOLFilter = organizedByVal === "Bill of Lading";

            // Always show Supplier and Source columns
            headers.forEach((header, index) => {
                if (index < 2) {
                    header.style.display = "";
                    return;
                }

                const headerName = headerTexts[index];
                const isBOLColumn = bolFields.some(bolField =>
                    headerName.includes(bolField.toLowerCase())
                );

                if (!isBOLFilter || isBOLColumn) {
                    header.style.display = "";
                } else {
                    header.style.display = "none";
                }
            });

            // ✅ If no supplier selected → show all rows but still apply availability and search filters
            if (supplierVal === "") {
                rows.forEach(row => {
                    const rowText = Array.from(row.cells).map(cell => cell.textContent.toLowerCase()).join(' ');
                    const matchSearch = searchVal === "" || rowText.includes(searchVal);
                    
                    // Apply availability filter even when no supplier is selected
                    let matchAvailability = true;
                    if (availabilityVal === "available") {
                        matchAvailability = !hasBOLNO(row);
                    }

                    if (matchSearch && matchAvailability) {
                        row.style.display = "";

                        Array.from(row.cells).forEach((cell, index) => {
                            if (index < 2) {
                                cell.style.display = "";
                                return;
                            }

                            const headerName = headerTexts[index];
                            const isBOLColumn = bolFields.some(bolField =>
                                headerName.includes(bolField.toLowerCase())
                            );

                            if (!isBOLFilter || isBOLColumn) {
                                cell.style.display = "";
                            } else {
                                cell.style.display = "none";
                            }
                        });

                        visibleCount++;
                    } else {
                        row.style.display = "none";
                    }
                });

                visibleCountSpan.textContent = visibleCount;
                updateNoResultsMessage(visibleCount);
                return; // Exit early – organized by filter doesn't apply without supplier
            }

            // Filtering starts only when a supplier is selected
            rows.forEach(row => {
                if (row.cells.length < 2) {
                    row.style.display = "none";
                    return;
                }

                const supplierBadge = row.cells[0].querySelector('.badge');
                const sourceBadge = row.cells[1].querySelector('.badge');

                const supplier = supplierBadge ? supplierBadge.textContent.trim() : '';
                const source = sourceBadge ? sourceBadge.textContent.trim() : '';
                const isBOL = isBillOfLading(row);
                const rowText = Array.from(row.cells).map(cell => cell.textContent.toLowerCase()).join(' ');

                const matchSupplier = supplierVal === "" || supplier === supplierVal;
                const supplierSelected = supplierVal !== "";

                let matchOrganizedBy = true;
                if (organizedByVal === "Bill of Lading") {
                    matchOrganizedBy = isBOL;
                } else if (organizedByVal !== "") {
                    matchOrganizedBy = source === organizedByVal;
                }

                // Availability filter: "available" means no BOLNO value
                let matchAvailability = true;
                if (availabilityVal === "available") {
                    matchAvailability = !hasBOLNO(row);
                }

                const matchSearch = searchVal === "" || rowText.includes(searchVal);

                if ((supplierSelected ? matchSupplier : true) && matchOrganizedBy && matchAvailability && matchSearch) {
                    row.style.display = "";

                    Array.from(row.cells).forEach((cell, index) => {
                        if (index < 2) {
                            cell.style.display = "";
                            return;
                        }

                        const headerName = headerTexts[index];
                        const isBOLColumn = bolFields.some(bolField =>
                            headerName.includes(bolField.toLowerCase())
                        );

                        if (!isBOLFilter || isBOLColumn) {
                            cell.style.display = "";
                        } else {
                            cell.style.display = "none";
                        }
                    });

                    visibleCount++;
                } else {
                    row.style.display = "none";
                }
            });

            visibleCountSpan.textContent = visibleCount;
            updateNoResultsMessage(visibleCount);
        }

        function updateNoResultsMessage(visibleCount) {
            let noResultsRow = tableBody.querySelector('.no-results-row');

            if (visibleCount === 0 && totalRows > 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = '<td colspan="100" class="text-center py-4"><em>No items match the current filters.</em></td>';
                    tableBody.appendChild(noResultsRow);
                } else {
                    noResultsRow.style.display = '';
                }
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
        }

        function clearFilters() {
            filterSupplier.value = "";
            filterOrganizedBy.value = "";
            filterAvailability.value = "";
            filterSearch.value = "";
            toggleFilterInputs();
            filterTable();
        }

        function toggleFilterInputs() {
            const isSupplierSelected = filterSupplier.value.trim() !== "";
            // Only disable "organized by" when no supplier is selected
            // Search should always be enabled
            filterOrganizedBy.disabled = !isSupplierSelected;

            // Reset "organized by" when supplier is deselected
            if (!isSupplierSelected) {
                filterOrganizedBy.value = "";
            }
        }

        // Attach event listeners
        filterSupplier.addEventListener("change", () => {
            toggleFilterInputs();
            filterTable();
        });

        filterOrganizedBy.addEventListener("change", filterTable);
        filterAvailability.addEventListener("change", filterTable);
        filterSearch.addEventListener("input", filterTable);
        clearFiltersBtn.addEventListener("click", clearFilters);

        // Initialize
        toggleFilterInputs();
        filterTable();
    });
</script>
{% endblock %}
