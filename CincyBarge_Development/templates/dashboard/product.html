{% extends 'partials/base.html' %}
{% load dashboard_extras %}
{% block title %}Products Page{% endblock %}

{% block content %}
{% include 'partials/topnav.html'%}

<div class="container-fluid">
    <div class="row my-4">

        <!-- Left Column: Import & Add Product Forms -->
        <div class="col-md-4">

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Upload Raw Inventory Data Form -->
            <div class="card card-body mt-4">
                <h5>Upload Raw Inventory Data</h5>
                <hr>
                <p class="text-muted small">Upload unstructured inventory data from CSV or JSON files. Data will be stored per supplier.</p>
                <form method="POST" action="{% url 'upload-raw-data' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Supplier Selection/Creation -->
                    <div class="form-group">
                        <label for="id_raw_supplier">Supplier</label>
                        <select name="supplier" id="id_raw_supplier" class="form-control" onchange="toggleNewSupplier()">
                            <option value="" disabled selected>Select a supplier</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                            <option value="new">+ Add New Supplier</option>
                        </select>
                    </div>

                    <!-- New Supplier Name Input (hidden by default) -->
                    <div class="form-group" id="newSupplierGroup" style="display: none;">
                        <label for="id_new_supplier_name">New Supplier Name</label>
                        <input type="text" name="new_supplier_name" id="id_new_supplier_name" class="form-control" placeholder="Enter new supplier name">
                        <small class="form-text text-muted">This will create a new supplier in the system</small>
                    </div>

                    <!-- File Upload -->
                    <div class="form-group">
                        <label for="id_file">File (CSV or JSON)</label>
                        <input type="file" name="file" id="id_file" class="form-control" accept=".csv,.json" required>
                        <small class="form-text text-muted">Upload a CSV or JSON file with inventory data</small>
                    </div>

                    <!-- Submit Button -->
                    <input class="btn btn-primary btn-block mt-3" type="submit" value="Upload File">
                </form>
                
                <!-- View Raw Data Button -->
                <a href="{% url 'raw-data-view' %}" class="btn btn-info btn-block mt-2">
                    View Uploaded Raw Data
                </a>
            </div>
        </div>

        <!-- Right Column: Unified Products Table -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Products Inventory (All Data)</h5>
                    <span class="badge badge-light">{{ total_rows }} total items</span>
                </div>

                <!-- Table -->
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover table-sm bg-white mb-0">
                            <thead class="bg-info text-white" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th scope="col" class="text-nowrap">Supplier</th>
                                    <th scope="col" class="text-nowrap">Source</th>
                                    {% for column in all_columns %}
                                    <th scope="col" class="text-nowrap">{{ column }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in all_inventory_data %}
                                <tr>
                                    <td class="text-nowrap">
                                        <span class="badge badge-info">{{ row.supplier }}</span>
                                    </td>
                                    <td class="text-nowrap">
                                        <span class="badge badge-{% if row.source == 'Structured' %}success{% else %}warning{% endif %}">
                                            {{ row.source }}
                                        </span>
                                    </td>
                                    {% for column in all_columns %}
                                    <td>{{ row.data|get_item:column|default:"-" }}</td>
                                    {% endfor %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{{ all_columns|length|add:2 }}" class="text-center">No inventory data found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-footer">
                    <small class="text-muted">
                        <strong>Total Items:</strong> {{ total_rows }} | 
                        <strong>Columns:</strong> {{ all_columns|length }}
                    </small>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Filter and Supplier Toggle Scripts -->
<script>
    // Toggle new supplier input field
    function toggleNewSupplier() {
        const supplierSelect = document.getElementById("id_raw_supplier");
        const newSupplierGroup = document.getElementById("newSupplierGroup");
        const newSupplierInput = document.getElementById("id_new_supplier_name");
        
        if (supplierSelect.value === "new") {
            newSupplierGroup.style.display = "block";
            newSupplierInput.required = true;
        } else {
            newSupplierGroup.style.display = "none";
            newSupplierInput.required = false;
            newSupplierInput.value = "";
        }
    }

    // Filter table logic
    document.addEventListener("DOMContentLoaded", function () {
        const filterName = document.getElementById("filterName");
        const filterSupplier = document.getElementById("filterSupplier");
        const filterStatus = document.getElementById("filterStatus");
        const rows = document.querySelectorAll("#productsTableBody tr");

        function filterTable() {
            const nameVal = filterName.value.toLowerCase();
            const supplierVal = filterSupplier.value;
            const statusVal = filterStatus.value;

            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase();
                const supplier = row.cells[1]?.textContent;
                const status = row.cells[3]?.textContent;

                const matchName = name.includes(nameVal);
                const matchSupplier = supplierVal === "" || supplier === supplierVal;
                const matchStatus = statusVal === "" || status === statusVal;

                if (matchName && matchSupplier && matchStatus) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        filterName.addEventListener("input", filterTable);
        filterSupplier.addEventListener("change", filterTable);
        filterStatus.addEventListener("change", filterTable);
    });
</script>
{% endblock %}
