{% extends 'partials/base.html' %}
{% block title %}Products Page{% endblock %}

{% block content %}
{% include 'partials/topnav.html'%}

<div class="container-fluid">
    <div class="row my-4">

        <!-- Left Column: Import & Add Product Forms -->
        <div class="col-md-4">

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Import Products from Google Sheet -->
            <div class="card card-body mb-4">
                <h5>Import Products from Google Sheet</h5>
                <hr>
                <form method="POST" action="{% url 'import_google_sheet' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="sheet_url">Google Sheet URL (public)</label>
                        <input type="url" name="sheet_url" class="form-control" placeholder="Paste public Google Sheet URL" required>
                    </div>
                    <button type="submit" class="btn btn-success btn-block mt-2">Import Products</button>
                </form>
            </div>

            <!-- Add New Product Form -->
            <div class="card card-body mt-4">
                <h5>Add New Product</h5>
                <hr>
                <form method="POST">
                    {% csrf_token %}

                    <!-- Product Name -->
                    <div class="form-group">
                        <label for="id_name">Product Name</label>
                        <input type="text" name="name" id="id_name" class="form-control" placeholder="Enter product name" required>
                    </div>

                    <!-- Quantity -->
                    <div class="form-group">
                        <label for="id_quantity">Quantity</label>
                        <input type="number" name="quantity" id="id_quantity" class="form-control" placeholder="Enter quantity" min="0" required>
                    </div>

                    <!-- Category Dropdown -->
                    <div class="form-group">
                        <label for="id_category">Category</label>
                        <select name="category" id="id_category" class="form-control" required>
                            <option value="" disabled selected>Select a category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Supplier Dropdown -->
                    <div class="form-group">
                        <label for="id_supplier">Supplier</label>
                        <select name="supplier" id="id_supplier" class="form-control" required>
                            <option value="" disabled selected>Select a supplier</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <input class="btn btn-success btn-block mt-3" type="submit" value="Add Product">
                </form>
            </div>
        </div>

        <!-- Right Column: Products Table -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Products Inventory</h5>
                </div>

                <!-- Filter Section -->
                <div class="p-3">
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <input type="text" id="filterName" class="form-control" placeholder="Filter by name">
                        </div>
                        <div class="form-group col-md-3">
                            <select id="filterCategory" class="form-control">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category.name }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <select id="filterSupplier" class="form-control">
                                <option value="">All Suppliers</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.name }}">{{ supplier.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <select id="filterStatus" class="form-control">
                                <option value="">All Statuses</option>
                                <option value="Available">Available</option>
                                <option value="Unavailable">Unavailable</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover bg-white mb-0">
                            <thead class="bg-info text-white">
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Category</th>
                                    <th scope="col">Supplier</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                {% for product in product %}
                                <tr>
                                    <td>{{ product.name }}</td>
                                    <td>{{ product.category }}</td>
                                    <td>{{ product.supplier.name }}</td>
                                    <td>{{ product.quantity }}</td>
                                    <td>
                                        {% if product.quantity > 50 %}
                                            <span class="badge badge-success">Available</span>
                                        {% else %}
                                            <span class="badge badge-danger">Unavailable</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No products found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-footer">
                    <small class="text-muted">
                        <strong>Total Products:</strong> <span id="totalProducts">{{ product|length }}</span>
                    </small>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Filter Logic Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filterName = document.getElementById("filterName");
        const filterCategory = document.getElementById("filterCategory");
        const filterSupplier = document.getElementById("filterSupplier");
        const filterStatus = document.getElementById("filterStatus");
        const rows = document.querySelectorAll("#productsTableBody tr");

        function filterTable() {
            const nameVal = filterName.value.toLowerCase();
            const categoryVal = filterCategory.value;
            const supplierVal = filterSupplier.value;
            const statusVal = filterStatus.value;

            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase();
                const category = row.cells[1]?.textContent;
                const supplier = row.cells[2]?.textContent;
                const status = row.cells[4]?.textContent;

                const matchName = name.includes(nameVal);
                const matchCategory = categoryVal === "" || category === categoryVal;
                const matchSupplier = supplierVal === "" || supplier === supplierVal;
                const matchStatus = statusVal === "" || status === statusVal;

                if (matchName && matchCategory && matchSupplier && matchStatus) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        filterName.addEventListener("input", filterTable);
        filterCategory.addEventListener("change", filterTable);
        filterSupplier.addEventListener("change", filterTable);
        filterStatus.addEventListener("change", filterTable);
    });
</script>
{% endblock %}
