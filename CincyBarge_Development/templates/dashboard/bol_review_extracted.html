{% extends 'partials/base.html' %}
{% block title %}Review Extracted BOL Data{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Review Extracted BOL Data</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'dashboard-index' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'dashboard-bol' %}">Bills of Lading</a></li>
        <li class="breadcrumb-item active">Review Extracted Data</li>
    </ol>

    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Review the extracted data below.</strong> The system has automatically extracted data from <strong>{{ extracted_data.pdf_filename }}</strong>. 
        Please verify all fields and make corrections where needed before saving.
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column -->
            <div class="col-xl-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-1"></i>
                        BOL Information
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Supplier</label>
                            <input type="text" class="form-control" value="{{ extracted_data.supplier_name }}" disabled>
                        </div>

                        <div class="mb-3">
                            <label for="bill_number" class="form-label">Bill Number</label>
                            <input type="text" class="form-control" id="bill_number" name="bill_number" 
                                   value="{{ extracted_data.bill_number|default:'' }}" 
                                   placeholder="Auto-generated if left blank">
                            <small class="form-text text-muted">Leave blank to auto-generate</small>
                        </div>

                        <div class="mb-3">
                            <label for="delivery_date" class="form-label">Delivery Date</label>
                            <input type="date" class="form-control" id="delivery_date" name="delivery_date" 
                                   value="{{ extracted_data.delivery_date|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="freight_charges" class="form-label">Freight Charges ($)</label>
                            <input type="number" step="0.01" class="form-control" id="freight_charges" name="freight_charges" 
                                   value="{{ extracted_data.freight_charges|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-building me-1"></i>
                        Shipper Information
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="shipper_name" class="form-label">Shipper Name</label>
                            <input type="text" class="form-control" id="shipper_name" name="shipper_name" 
                                   value="{{ extracted_data.shipper_name|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="shipper_address" class="form-label">Shipper Address</label>
                            <textarea class="form-control" id="shipper_address" name="shipper_address" rows="3">{{ extracted_data.shipper_address|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="origin" class="form-label">Origin / Port of Loading</label>
                            <input type="text" class="form-control" id="origin" name="origin" 
                                   value="{{ extracted_data.origin|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-building me-1"></i>
                        Consignee Information
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="consignee_name" class="form-label">Consignee Name</label>
                            <input type="text" class="form-control" id="consignee_name" name="consignee_name" 
                                   value="{{ extracted_data.consignee_name|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="consignee_address" class="form-label">Consignee Address</label>
                            <textarea class="form-control" id="consignee_address" name="consignee_address" rows="3">{{ extracted_data.consignee_address|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="destination" class="form-label">Destination / Port of Discharge</label>
                            <input type="text" class="form-control" id="destination" name="destination" 
                                   value="{{ extracted_data.destination|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-xl-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-ship me-1"></i>
                        Transport Information
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="carrier" class="form-label">Carrier</label>
                            <input type="text" class="form-control" id="carrier" name="carrier" 
                                   value="{{ extracted_data.carrier|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="vessel_name" class="form-label">Vessel / Barge Name</label>
                            <input type="text" class="form-control" id="vessel_name" name="vessel_name" 
                                   value="{{ extracted_data.vessel_name|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="container_number" class="form-label">Container Number</label>
                            <input type="text" class="form-control" id="container_number" name="container_number" 
                                   value="{{ extracted_data.container_number|default:'' }}">
                        </div>

                        <div class="mb-3">
                            <label for="seal_number" class="form-label">Seal Number</label>
                            <input type="text" class="form-control" id="seal_number" name="seal_number" 
                                   value="{{ extracted_data.seal_number|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-boxes me-1"></i>
                        Line Items
                        {% if extracted_data.line_items %}
                            <span class="badge bg-primary">{{ extracted_data.line_items|length }} items extracted</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if extracted_data.line_items %}
                            <p class="text-muted mb-3">Review the extracted line items below. Uncheck any items you don't want to include.</p>
                            
                            {% for item in extracted_data.line_items %}
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" 
                                               id="include_item_{{ forloop.counter0 }}" 
                                               name="include_item_{{ forloop.counter0 }}" 
                                               checked>
                                        <label class="form-check-label" for="include_item_{{ forloop.counter0 }}">
                                            <strong>Include Item #{{ forloop.counter }}</strong>
                                        </label>
                                    </div>

                                    <div class="mb-2">
                                        <label for="item_description_{{ forloop.counter0 }}" class="form-label small">Description</label>
                                        <textarea class="form-control form-control-sm" 
                                                  id="item_description_{{ forloop.counter0 }}" 
                                                  name="item_description_{{ forloop.counter0 }}" 
                                                  rows="2">{{ item.description|default:'' }}</textarea>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label for="item_quantity_{{ forloop.counter0 }}" class="form-label small">Quantity</label>
                                            <input type="number" class="form-control form-control-sm" 
                                                   id="item_quantity_{{ forloop.counter0 }}" 
                                                   name="item_quantity_{{ forloop.counter0 }}" 
                                                   value="{{ item.quantity|default:'1' }}" min="1">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label for="item_weight_{{ forloop.counter0 }}" class="form-label small">Weight (lbs)</label>
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   id="item_weight_{{ forloop.counter0 }}" 
                                                   name="item_weight_{{ forloop.counter0 }}" 
                                                   value="{{ item.weight|default:'' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No line items were extracted from the PDF. You can add products manually after creating the BOL.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-plus-circle me-1"></i>
                        Add Products from Inventory
                        {% if available_products %}
                            <span class="badge bg-light text-dark">{{ available_products|length }} products available</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if available_products %}
                            <p class="text-muted mb-3">
                                <i class="fas fa-search me-1"></i>
                                Search and filter products below, then check the ones you want to add to this BOL:
                            </p>
                            
                            <div class="table-responsive">
                                <table id="productsTable" class="table table-sm table-hover table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="50">Select</th>
                                            <th>Product Name</th>
                                            <th>Supplier</th>
                                            <th>Quantity</th>
                                            <th>Weight (lbs)</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product in available_products %}
                                        <tr>
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input" 
                                                       id="add_product_{{ product.id }}" 
                                                       name="add_product_{{ product.id }}"
                                                       value="1">
                                                <input type="hidden" name="add_product_qty_{{ product.id }}" value="{{ product.quantity }}">
                                                <input type="hidden" name="add_product_weight_{{ product.id }}" value="{{ product.weight|default:'' }}">
                                            </td>
                                            <td><strong>{{ product.name }}</strong></td>
                                            <td>
                                                {% if product.supplier %}
                                                    <span class="badge bg-warning text-dark">{{ product.supplier.name }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td><span class="badge bg-secondary">{{ product.quantity }}</span></td>
                                            <td>
                                                {% if product.weight %}
                                                    <span class="badge bg-info">{{ product.weight }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td><small>{{ product.description|truncatewords:15|default:"-" }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                No products found in the database. Add products first via the Products page.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-sticky-note me-1"></i>
                        Notes
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="notes" name="notes" rows="4" 
                                  placeholder="Additional notes or special instructions">{{ extracted_data.notes|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-check me-1"></i> Save Bill of Lading
                    </button>
                    <a href="{% url 'dashboard-bol' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-1"></i> Cancel
                    </a>
                </div>
                <small class="text-muted d-block mt-2">
                    The BOL will be saved as a draft. You can add more products or make changes before confirming it.
                </small>
            </div>
        </div>
    </form>
</div>

<style>
    .card-header .badge {
        float: right;
    }
    #productsTable_wrapper .dataTables_filter {
        float: right;
    }
    #productsTable_wrapper .dataTables_length {
        float: left;
    }
</style>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<script>
$(document).ready(function() {
    // Initialize DataTables for products table
    $('#productsTable').DataTables({
        "pageLength": 10,
        "order": [[1, "asc"]], // Sort by product name
        "columnDefs": [
            { "orderable": false, "targets": 0 } // Disable sorting on checkbox column
        ],
        "language": {
            "search": "Search products:",
            "lengthMenu": "Show _MENU_ products per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ products",
            "infoEmpty": "No products available",
            "infoFiltered": "(filtered from _MAX_ total products)",
            "zeroRecords": "No matching products found"
        }
    });
});
</script>
{% endblock %}
