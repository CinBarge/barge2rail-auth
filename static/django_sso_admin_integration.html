<!DOCTYPE html>
<html>
<head>
    <title>Django SSO Integration for Admin Dashboard</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        .button { display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .step { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Django SSO Integration for Admin Dashboard</h1>
    <p><strong>Purpose:</strong> Authenticate with Django SSO and return to Admin Dashboard</p>

    <div class="step">
        <h3>Step 1: Complete Google Authentication</h3>
        <div id="g_id_onload"
             data-client_id="930712511884-uaodug30nbbjif7qje1gjb48ahm3n2nj.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div id="step2" class="step" style="display:none;">
        <h3>Step 2: Authentication Results</h3>
        <div id="auth-results"></div>
    </div>

    <div id="step3" class="step" style="display:none;">
        <h3>Step 3: Return to Admin Dashboard</h3>
        <div id="return-options"></div>
    </div>

    <script>
        async function handleCredentialResponse(response) {
            console.log("=== STARTING DJANGO SSO INTEGRATION ===");
            document.getElementById('step2').style.display = 'block';

            try {
                // Send Google credential to Django SSO
                const authResponse = await fetch('http://127.0.0.1:8000/api/auth/login/google/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: response.credential
                    })
                });

                if (!authResponse.ok) {
                    throw new Error(`HTTP ${authResponse.status}`);
                }

                const data = await authResponse.json();
                console.log('Django SSO Response:', data);

                // CRITICAL: Store tokens to localStorage for Admin Dashboard
                localStorage.setItem('django_sso_access_token', data.access_token);
                localStorage.setItem('django_sso_refresh_token', data.refresh_token);

                // Show success message
                document.getElementById('auth-results').innerHTML = `
                    <div class="success">
                        <h4>✅ Django SSO Authentication Successful!</h4>
                        <p><strong>User:</strong> ${data.user.email}</p>
                        <p><strong>Display Name:</strong> ${data.user.display_name}</p>
                        <p><strong>Admin Status:</strong> ${data.user.is_sso_admin ? 'Admin' : 'User'}</p>
                        <p><strong>Tokens Stored:</strong> ✅ Access Token, ✅ Refresh Token</p>
                    </div>
                `;

                // Show return options
                document.getElementById('step3').style.display = 'block';
                document.getElementById('return-options').innerHTML = `
                    <div class="success">
                        <p><strong>Authentication Complete!</strong> Your Django SSO tokens have been stored.</p>
                        <p>Click the button below to return to Admin Dashboard:</p>
                        <a href="http://localhost:3000" class="button success">
                            Return to Admin Dashboard
                        </a>
                        <p><small>The Admin Dashboard will automatically detect your authentication tokens and log you in.</small></p>
                    </div>
                `;

                // Optional: Auto-redirect after 3 seconds
                setTimeout(() => {
                    if (confirm('Authentication successful! Redirect to Admin Dashboard now?')) {
                        window.location.href = 'http://localhost:3000';
                    }
                }, 2000);

            } catch (error) {
                console.error('Django SSO Error:', error);
                document.getElementById('auth-results').innerHTML = `
                    <div class="error">
                        <h4>❌ Django SSO Authentication Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please try again or contact support.</p>
                    </div>
                `;
            }
        }

        // Debug: Show current localStorage state
        window.addEventListener('load', () => {
            const accessToken = localStorage.getItem('django_sso_access_token');
            const refreshToken = localStorage.getItem('django_sso_refresh_token');

            if (accessToken && refreshToken) {
                document.getElementById('step2').style.display = 'block';
                document.getElementById('step3').style.display = 'block';

                document.getElementById('auth-results').innerHTML = `
                    <div class="warning">
                        <h4>⚠️ Existing Authentication Detected</h4>
                        <p>You already have Django SSO tokens stored.</p>
                        <p><strong>Access Token:</strong> ${accessToken.substring(0, 50)}...</p>
                        <p><strong>Refresh Token:</strong> ${refreshToken.substring(0, 50)}...</p>
                    </div>
                `;

                document.getElementById('return-options').innerHTML = `
                    <div class="success">
                        <p><strong>You're already authenticated!</strong></p>
                        <a href="http://localhost:3000" class="button success">
                            Return to Admin Dashboard
                        </a>
                        <button onclick="clearTokensAndReauth()" class="button" style="background: #dc3545;">
                            Clear Tokens & Re-authenticate
                        </button>
                    </div>
                `;
            }
        });

        function clearTokensAndReauth() {
            localStorage.removeItem('django_sso_access_token');
            localStorage.removeItem('django_sso_refresh_token');
            location.reload();
        }
    </script>
</body>
</html>
