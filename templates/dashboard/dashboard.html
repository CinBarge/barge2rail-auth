{% extends 'base.html' %}

{% block title %}Dashboard - Barge2Rail SSO{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">SSO Dashboard</h2>

<div class="stats-grid">
    <div class="stat-card">
        <h3>{{ user_count }}</h3>
        <p>Total Users</p>
    </div>
    <div class="stat-card">
        <h3>{{ app_count }}</h3>
        <p>Applications</p>
    </div>
    <div class="stat-card">
        <h3>{{ role_count }}</h3>
        <p>User Roles</p>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 1rem;">Recent Users</h3>
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Name</th>
                <th>SSO Admin</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for user in recent_users %}
            <tr>
                <td>{{ user.email }}</td>
                <td>{{ user.get_full_name|default:user.username }}</td>
                <td>{{ user.is_sso_admin|yesno:"Yes,No" }}</td>
                <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="text-align: center; color: #666;">No users yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3 style="margin-bottom: 1rem;">Recent Applications</h3>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Client ID</th>
                <th>Active</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for app in recent_apps %}
            <tr>
                <td>{{ app.name }}</td>
                <td style="font-family: monospace; font-size: 0.9rem;">{{ app.client_id }}</td>
                <td>{{ app.is_active|yesno:"Yes,No" }}</td>
                <td>{{ app.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="text-align: center; color: #666;">No applications yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem;">Connected Applications</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <a href="#" onclick="openCincyBarge(event)" class="app-link" style="display: block; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; transition: transform 0.2s; cursor: pointer;">
            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">CincyBarge2Rail</h4>
            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Order Management System</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">http://127.0.0.1:8001</p>
        </a>
        <div class="app-link" style="display: flex; align-items: center; justify-content: center; padding: 1.5rem; background: #f5f5f5; border: 2px dashed #ccc; border-radius: 8px; color: #999;">
            <span style="font-size: 0.9rem;">More applications coming soon...</span>
        </div>
    </div>
</div>

<div style="margin-top: 2rem;">
    <a href="{% url 'admin:index' %}" class="btn">Go to Django Admin</a>
</div>

<style>
.app-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>

<script>
function openCincyBarge(event) {
    event.preventDefault();
    
    // Get user data from current session
    const userData = {
        email: '{{ user.email }}',
        username: '{{ user.username }}',
        first_name: '{{ user.first_name }}',
        last_name: '{{ user.last_name }}',
        is_staff: {{ user.is_staff|yesno:"true,false" }},
        is_superuser: {{ user.is_superuser|yesno:"true,false" }}
    };
    
    // Create a form to POST the SSO data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'http://127.0.0.1:8001/sso-login/';
    form.target = '_blank';
    
    // Add CSRF bypass (handled in sso_login view)
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = 'sso-bypass';
    form.appendChild(csrfInput);
    
    // Add user data
    for (const [key, value] of Object.entries(userData)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    // Add SSO signature for verification
    const signatureInput = document.createElement('input');
    signatureInput.type = 'hidden';
    signatureInput.name = 'sso_signature';
    signatureInput.value = btoa('{{ user.email }}:{{ user.id }}');
    form.appendChild(signatureInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
</script>
{% endblock %}
